<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>รายงานสรุปผลการดำเนินงาน</title>
    <link rel="stylesheet" href="{{ asset('css/styles.css') }}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">

    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/2.2.2/css/dataTables.dataTables.min.css">
</head>

<style>
    #loadingIndicator {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(255, 255, 255, 0.9);
        padding: 30px 50px;
        border-radius: 10px;
        text-align: center;
        box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.2);
        display: none;
        z-index: 1050;
    }
</style>

<body class="bg-light">
    <div class="container mt-4">
        <h2 class="text-center text-primary">สรุปรายงาน - ด้านคะแนน PA</h2>
        <div class="card shadow-sm p-3 mb-4 bg-white rounded">
            <form method="GET" action="{{ url()->current() }}" class="row g-3" id="filterForm">
                @csrf
                <div class="col-md-3">
                    <label class="form-label">ปี:</label>
                    <select name="year" class="form-select" id="yearSelect">
                        @foreach(range(2025, 2019) as $y)
                            <option value="{{ $y }}" {{ $year == $y ? 'selected' : '' }}>
                                {{ $y + 543 }}
                            </option>
                        @endforeach
                    </select>
                </div>
                <div class="col-md-4">
                    @include('components.unit_dropdown', ['units' => $units, 'unit_name' => $unit_name])
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="button" class="btn btn-primary w-100" onclick="submitForm()">แสดงข้อมูล</button>
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <a href="{{ route('export.pdf', ['year' => $year, 'unit_name' => $unit_name, 'department' => $department]) }}"
                       id="exportBtn"
                       class="btn btn-danger w-100"
                       onclick="startDownload(event)">
                        Export PDF
                    </a>
                </div>
            </form>
        </div>

        <!-- Checkbox กรอง -->
        <div class="col-md-12 mt-3">
            <div class="form-check">
                <input class="form-check-input" type="checkbox" value="1" id="unitCheckbox" name="unitCheckbox">
                <label class="form-check-label" for="unitCheckbox">หน่วยงานนั้น</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" value="1" id="subUnitCheckbox" name="subUnitCheckbox">
                <label class="form-check-label" for="subUnitCheckbox">หน่วยงานใต้สังกัด</label>
            </div>
        </div>

        <!-- หัวข้อ -->
        <div class="text-center my-4">
            <h4>บันทึกข้อตกลงการประเมินผลการดำเนินงานระดับสายงาน ประจำปี {{ $year+543}}</h4>
            <p class="text-muted">
                งวด 6 เดือน (1 มกราคม - 30 มิถุนายน {{ $year+543 }}) และงวดสิ้นปี (1 กรกฎาคม - 31 ธันวาคม {{ $year+543 }})
            </p>
        </div>

        @if($unit_name && $year)
        <div class="table-responsive">
            <table id="myTable" class="table table-bordered text-center table-hover">
                <thead class="table-dark">
                    <tr>
                        <th rowspan="2">เกณฑ์วัดการดำเนินงาน</th>
                        <th rowspan="2">งวดประเมิน</th>
                        <th rowspan="2">หน่วยวัด</th>
                        <th rowspan="2">น้ำหนัก (ร้อยละ)</th>
                        <th colspan="5">ค่าเกณฑ์วัดปีบัญชี {{ $year+543 }} </th>
                        <th rowspan="2">ผู้รับผิดชอบ</th>
                    </tr>
                    <tr>
                        <th>1</th>
                        <th>2</th>
                        <th>3</th>
                        <th>4</th>
                        <th>5</th>
                    </tr>
                </thead>
                <tbody>
                    @forelse ($units as $unit)
                        <tr>
                            <td>{{ $unit->score_name ?: '-' }}</td>
                            <td>{{ $unit->score_type ?: '-' }}</td>
                            <td>{{ $unit->unit ?: '-' }}</td>
                            <td>
                                @php
                                $weightParts = explode('.', $unit->weight);
                                $weightDisplay = (count($weightParts) > 1 && (int) $weightParts[1] > 0) ? number_format($unit->weight, 2) : (int) $unit->weight;
                                @endphp
                                {{ $weightDisplay }}
                            </td>
                            <td>{{ $unit->score1 ?: '-' }}</td>
                            <td>{{ $unit->score2 ?: '-' }}</td>
                            <td>{{ $unit->score3 ?: '-' }}</td>
                            <td>{{ $unit->score4 ?: '-' }}</td>
                            <td>{{ $unit->score5 ?: '-' }}</td>
                            <td>{{ $unit->name_s ?: 'ทุกสายงาน' }}</td>
                        </tr>
                    @empty
                        <tr>
                            <td colspan="10" class="text-danger">ไม่มีข้อมูล</td>
                        </tr>
                    @endforelse
                </tbody>
            </table>
        </div>
        @else
            <div class="alert alert-warning text-center">
                <strong>กรุณาเลือกหน่วยงานและปีที่ต้องการดูข้อมูล</strong>
            </div>
        @endif
    </div>

    <!-- Spinner -->
    <div id="loadingIndicator">
        <div class="spinner-border text-danger" role="status"></div>
        <p class="mt-2 text-danger">กำลังดาวน์โหลด กรุณารอสักครู่...</p>
    </div>

    <!-- jQuery & DataTables -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/2.2.2/js/dataTables.min.js"></script>

    <!-- เรียกใช้ DataTables -->
    <script>
        $(document).ready(function () {
            $('#myTable').DataTable({
                language: {
                    url: "//cdn.datatables.net/plug-ins/1.13.6/i18n/th.json"
                },
                pageLength: 10,
                lengthMenu: [ [10, 25, 50, -1], [10, 25, 50, "ทั้งหมด"] ],
                responsive: true
            });
        });
    </script>

    <!-- Export PDF -->
    <script>
        async function startDownload(event) {
            event.preventDefault();

            let exportBtn = document.getElementById('exportBtn');
            let loadingIndicator = document.getElementById('loadingIndicator');

            exportBtn.style.display = 'none';
            loadingIndicator.style.display = 'block';

            try {
                let response = await fetch(event.target.href);
                if (!response.ok) throw new Error("ดาวน์โหลดล้มเหลว");

                let blob = await response.blob();
                let url = window.URL.createObjectURL(blob);
                let a = document.createElement('a');
                a.href = url;
                a.download = 'report.pdf';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);

                setTimeout(() => {
                    loadingIndicator.style.display = 'none';
                    exportBtn.style.display = 'block';
                }, 1000);
            } catch (error) {
                console.error("เกิดข้อผิดพลาด:", error);
                alert("เกิดข้อผิดพลาดในการดาวน์โหลด กรุณาลองใหม่");
                loadingIndicator.style.display = 'none';
                exportBtn.style.display = 'block';
            }
        }
    </script>

    <!-- Submit Form -->
    <script>
        function submitForm() {
            document.getElementById('filterForm').submit();
        }

        document.getElementById('yearSelect').addEventListener('change', submitForm);
        document.getElementById('unit_name').addEventListener('change', submitForm);
        document.getElementById('department').addEventListener('change', submitForm);
    </script>
</body>
</html>


<div class="row">
    <!-- Dropdown ระดับ -->
    <div class="control-group">
        <label class="form-label">ระดับ:</label>
        <select name="unit_name" id="unit_name" class="form-select">
            <option value="" {{ request('unit_name', $unit_name) == '' ? 'selected' : '' }}>เลือกระดับ</option>
            @foreach ($units->unique('unit_name')->where('unit_name', '!=', '') as $unit)
                <option value="{{ $unit->unit_name }}" {{ request('unit_name', $unit_name) == $unit->unit_name ? 'selected' : '' }}>
                    {{ $unit->unit_name }}
                </option>
            @endforeach
        </select>
    </div>



public function showReport()
{
    // ดึงข้อมูลจากฐานข้อมูลด้วยการใช้ left join
    $units = DB::table('your_table as a')
        ->leftJoin('scores as b', 'a.id', '=', 'b.pa_id')
        ->leftJoin('score_levels as c', 'b.id', '=', 'c.score_id')
        ->leftJoin('score_level_orgs as d', 'c.id', '=', 'd.score_level_id')
        ->leftJoin('m_levels as e', 'c.m_level_id', '=', 'e.id')
        ->leftJoin('score_score_types as f', 'c.id', '=', 'f.score_level_id')
        ->leftJoin('score_types as g', 'f.score_type_id', '=', 'g.id')
        ->leftJoin('m_orgs as og', 'd.m_org_id', '=', 'og.id')
        ->select(
            'a.year',
            'e.name as unit_name',
            'a.name as score_name',
            'g.name as score_type',
            'b.unit',
            'b.score1',
            'b.score2',
            'b.score3',
            'b.score4',
            'b.score5',
            'c.m_level_id',
            'og.name_s',  // ดึงค่า name_s จาก m_orgs
            'd.weight',
            'a.common_flag'
        )
        ->get();

    // ส่งข้อมูลไปยัง View
    return view('report', compact('units'));
}





<!-- Add these in your HTML head section -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/selectize.js/0.12.6/css/selectize.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/selectize.js/0.12.6/js/standalone/selectize.min.js"></script>

<!-- แสดงในไฟล์ Blade (เช่น report.blade.php) -->
<div class="row">
    <!-- Dropdown ระดับ -->
    <div class="control-group col-md-6">
        <label class="form-label">ระดับ:</label>
        <select id="unit_name" class="form-select">
            <option value="">เลือกระดับ...</option>
            @foreach ($units as $unit)
                <option value="{{ $unit->unit_name }}">{{ $unit->unit_name }}</option>
            @endforeach
        </select>
    </div>

    <!-- Dropdown หน่วยงาน -->
    <div class="control-group col-md-6">
        <label class="form-label">หน่วยงาน:</label>
        <select id="department" class="form-select">
            <option value="">เลือกหน่วยงาน...</option>
            @foreach ($units as $unit)
                <option value="{{ $unit->name_s }}">{{ $unit->name_s }}</option>
            @endforeach
        </select>
    </div>
</div>

<!-- JavaScript ที่ใช้ในการกำหนดการแสดงผลของ Selectize -->
<script>
    $(document).ready(function () {
        // Dropdown ระดับ
        $('#unit_name').selectize({
            create: false,
            sortField: 'name'
        });

        // Dropdown หน่วยงาน
        $('#department').selectize({
            create: false,
            sortField: 'name'
        });
    });
</script>



<?php

namespace App\Http\Controllers;

use Barryvdh\DomPDF\Facade\Pdf;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;

class ReportController extends Controller
{
    private function getUnitsData($year, $unit_name, $department, $unitCheckbox, $subUnitCheckbox)
{
    $query = DB::table('pas as a')
        ->joinSub(
            DB::table(DB::raw("(SELECT pa_id, m_action_id,
            (CASE
                WHEN action_at = MAX(action_at) OVER (PARTITION BY pa_id)
                THEN action_at
            END) latest_action_at
            FROM trx_pa_logs) x"))
                ->whereNotNull('latest_action_at')
                ->where('m_action_id', 3),
            'y',
            'a.id',
            '=',
            'y.pa_id'
        )
        ->leftJoin('scores as b', 'a.id', '=', 'b.pa_id')
        ->leftJoin('score_levels as c', 'b.id', '=', 'c.score_id')
        ->leftJoin('score_level_orgs as d', 'c.id', '=', 'd.score_level_id')
        ->leftJoin('m_levels as e', 'c.m_level_id', '=', 'e.id')
        ->leftJoin('score_score_types as f', 'c.id', '=', 'f.score_level_id')
        ->leftJoin('score_types as g', 'f.score_type_id', '=', 'g.id')
        ->leftJoin('m_orgs as og', 'd.m_org_id', '=', 'og.id')
        ->select(
            'a.year',
            'e.name as unit_name',
            'a.name as score_name',
            'g.name as score_type',
            'b.unit',
            'b.score1',
            'b.score2',
            'b.score3',
            'b.score4',
            'b.score5',
            'c.m_level_id',
            'og.name_s',  // ดึงค่า name_s จาก m_orgs
            'd.weight',
            'a.common_flag'
        )
        ->where('a.year', $year)
        ->when(!empty($unit_name), function ($query) use ($unit_name) {
            return $query->where('e.name', 'LIKE', "%$unit_name%"); // ใช้ LIKE กับ unit_name
        })
        ->when(!empty($department), function ($query) use ($department) {
            return $query->where('og.hierachy_path', 'LIKE', "%$department%"); // ใช้ LIKE กับ department
        })
        ->whereNotNull('b.id')
        ->whereNull('a.deleted_at')
        ->distinct();

    // กรองตามการเลือก checkbox
    if ($unitCheckbox && !$subUnitCheckbox) {
        // กรณีเลือก "หน่วยงานนั้น"
        $query->where('og.hierachy_path', 'LIKE', "%$department%");
    } elseif (!$unitCheckbox && $subUnitCheckbox) {
        // กรณีเลือก "หน่วยงานใต้สังกัด"
        $query->where(function ($q) use ($department) {
            $q->where('og.hierachy_path', 'NOT LIKE', "%$department%")
              ->whereNotNull('og.hierachy_path'); // เพื่อป้องกัน NULL
        });
    }

    // กรณีเลือกทั้งสอง checkbox (แสดงทั้งหมด)
    if ($unitCheckbox && $subUnitCheckbox) {
        // แสดงทั้งหมด
        return $query->get();
    }

    return $query->get();
}

    
public function show(Request $request)
{
    $year = $request->input('year', date('Y'));
    $unit_name = $request->input('unit_name', ''); // ค่าที่รับจากฟอร์ม
    $department = $request->input('department', ''); // ค่าที่รับจากฟอร์ม
    $unitCheckbox = $request->has('unitCheckbox'); // เช็คว่าหน่วยงานนั้นถูกเลือกไหม
    $subUnitCheckbox = $request->has('subUnitCheckbox'); // เช็คว่าหน่วยงานใต้สังกัดถูกเลือกไหม

    // ดึงข้อมูลที่กรองตามปี, หน่วยงาน และหน่วยงานภายใน
    $units = $this->getUnitsData($year, $unit_name, $department, $unitCheckbox, $subUnitCheckbox);

    // ส่งข้อมูลไปยัง View
    return view('report_pa', compact('units', 'year', 'unit_name', 'department'));
}

public function exportPdf(Request $request)
{
    ini_set('memory_limit', '53248M');
    ini_set('max_execution_time', 300);

    $year = $request->input('year', date('Y'));
    $unit_name = $request->input('unit_name', ''); // ค่าที่รับจากฟอร์ม
    $department = $request->input('department', ''); // ค่าที่รับจากฟอร์ม
    $unitCheckbox = $request->has('unitCheckbox'); // เช็คว่าหน่วยงานนั้นถูกเลือกไหม
    $subUnitCheckbox = $request->has('subUnitCheckbox'); // เช็คว่าหน่วยงานใต้สังกัดถูกเลือกไหม

    // ดึงข้อมูลที่กรองตามปี, หน่วยงาน และหน่วยงานภายใน
    $units = $this->getUnitsData($year, $unit_name, $department, $unitCheckbox, $subUnitCheckbox);

    // สร้างไฟล์ PDF โดยใช้ข้อมูลที่กรองมา
    $pdf = Pdf::loadView('export_pdf', compact('units', 'year', 'unit_name', 'department'))
        ->setPaper('A4', 'landscape'); // ตั้งค่ากระดาษเป็น A4 แบบ landscape

    // ดาวน์โหลดไฟล์ PDF
    return $pdf->download('report_' . $year . '.pdf');
}
}
