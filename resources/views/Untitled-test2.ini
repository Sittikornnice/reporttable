<div class="row">
    <!-- Dropdown ระดับ -->
    <div class="col-md-6">
        <label for="unit_name" class="form-label">ระดับ:</label>
        <select name="unit_name" id="unit_name" disabled>
            <option value="" {{ request('unit_name', $unit_name) == '' ? 'selected' : '' }}>เลือกระดับ...</option>
            @foreach ($units->unique('unit_name')->where('unit_name', '!=', '') as $unit)
                <option value="{{ $unit->unit_name }}" {{ request('unit_name', $unit_name) == $unit->unit_name ? 'selected' : '' }}>
                    {{ $unit->unit_name }}
                </option>
            @endforeach
        </select>
    </div>

    <!-- Dropdown หน่วยงาน -->
    <div class="col-md-6">
        <label for="department" class="form-label">หน่วยงาน:</label>
        <select name="department" id="department" disabled>
    <option value="" {{ request('department', $department) == '' ? 'selected' : '' }}>เลือกหน่วยงาน...</option>
<?php
if ($subUnitCheckbox==1){ 
    ?>
     <option value="{{ request('department', $department) }}" selected>
            {{ request('department', $department) }}
        </option>
<?php
    }
    ?>

    @foreach ($units->unique('name_s')->where('name_s', '!=', '') as $unit)
        <option value="{{ $unit->name_s }}" {{ request('department', $department) == $unit->name_s ? 'selected' : '' }}>
            {{ $unit->name_s }}
        </option>
    @endforeach
</select>
    </div>
</div>

<!-- Spinner -->
<div id="loadingSpinner" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 9999;">
    <div style="background: #efefef; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); padding: 24px 32px; display: flex; flex-direction: row; align-items: center;">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem; margin-right: 18px;">
        </div>
        <div style="font-size: 1.2rem; color: #333;">
            กำลังโหลด...
        </div>
    </div>
</div>

<form method="GET" action="{{ route('report.pa') }}" id="filterForm">
    <div class="col-md-12 mt-3" style="margin-left: -315px;">
        <div class="form-check">
            <input class="form-check-input" type="checkbox" value="1" id="unitCheckbox" name="unitCheckbox"
                {{ request()->has('unitCheckbox') || !request()->has('unitCheckbox') && !request()->has('subUnitCheckbox') ? 'checked' : '' }}>
            <label class="form-check-label" for="unitCheckbox">หน่วยงานนั้น</label>
        </div> 
        <div class="form-check">
            <input class="form-check-input" type="checkbox" value="1" id="subUnitCheckbox" name="subUnitCheckbox"
                {{ request()->has('subUnitCheckbox') || !request()->has('unitCheckbox') && !request()->has('subUnitCheckbox') ? 'checked' : '' }}>
            <label class="form-check-label" for="subUnitCheckbox">หน่วยงานใต้สังกัด</label>
        </div>
    </div>
</form>


<script>
    let lastSelectedDepartment = document.getElementById('department').value;
    const departmentDropdown = document.getElementById('department');
    const allDepartmentOptions = Array.from(departmentDropdown.options).map(option => option.cloneNode(true));

    function showLoadingSpinner() {
        const spinner = document.getElementById('loadingSpinner');
        spinner.style.display = 'block';
        setTimeout(() => {
            spinner.style.display = 'none';
        }, 5000); // ปรับเวลาได้ตามต้องการ
    }

    // อัปเดตค่าที่เลือกไว้ล่าสุดทุกครั้งที่เปลี่ยน dropdown
    departmentDropdown.addEventListener('change', function() {
        lastSelectedDepartment = this.value;
    });

    function lockDepartmentDropdown() {
        // ลบ option ทั้งหมดก่อน
    //     departmentDropdown.innerHTML = '';
    //     // เพิ่ม option ที่เลือกไว้ล่าสุดเท่านั้น (ถ้าไม่ใช่ค่าว่าง)
    //     allDepartmentOptions.forEach(option => {
    //         if (option.value === lastSelectedDepartment && lastSelectedDepartment !== "") {
    //             departmentDropdown.appendChild(option.cloneNode(true));
    //         }
    //     });
    //     // ถ้าเลือกค่าว่างไว้ ให้เพิ่ม option ว่าง
    //     if (lastSelectedDepartment === "") {
    //         allDepartmentOptions.forEach(option => {
    //             if (option.value === "") {
    //                 departmentDropdown.appendChild(option.cloneNode(true));
    //             }
    //         });
    //     }
    //     departmentDropdown.value = lastSelectedDepartment;
    }

    function unlockDepartmentDropdown() {
        departmentDropdown.innerHTML = '';
        allDepartmentOptions.forEach(option => {
            departmentDropdown.appendChild(option.cloneNode(true));
        });
        departmentDropdown.value = lastSelectedDepartment;
    }

    document.getElementById('unitCheckbox').addEventListener('change', showLoadingSpinner);
    document.getElementById('subUnitCheckbox').addEventListener('change', function() {
        showLoadingSpinner();
        if (this.checked) {
            // lockDepartmentDropdown();
        } else {
            // unlockDepartmentDropdown();
        }
    });

    window.addEventListener('DOMContentLoaded', function() {
        const subUnitCheckbox = document.getElementById('subUnitCheckbox');
        if (subUnitCheckbox.checked) {
            lockDepartmentDropdown();
        }
    });
</script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    // ตรวจสอบว่ามีการเลือกปีและ submit แล้วหรือยัง
    const urlParams = new URLSearchParams(window.location.search);
    const hasYear = urlParams.has('year') && urlParams.get('year') !== '';
    const hasSubmit = urlParams.has('unit_name') || urlParams.has('department');

    // ถ้าเลือกปีและมีการ submit แล้ว ให้ enable dropdown
    if (hasYear && hasSubmit) {
        document.getElementById('unit_name').disabled = false;
        document.getElementById('department').disabled = false;
    }

    // เมื่อเลือกปีและกดปุ่ม "แสดงข้อมูล" ให้ enable dropdown หลัง reload
    document.querySelector('.btn-primary').addEventListener('click', function () {
        document.getElementById('unit_name').disabled = false;
        document.getElementById('department').disabled = false;
    });
});
</script>